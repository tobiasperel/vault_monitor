^C
sed -i '' '/Check if we.*re in a browser environment/,/module.exports/d' src/dashboard/script.js
// Dashboard JavaScript

// Utility functions
function formatNumber(num, decimals = 2) {
  if (num === null || num === undefined) return "-";
  return Number(num).toLocaleString(undefined, {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals,
  });
}

function formatAddress(address) {
  if (!address) return "-";
  return `${address.slice(0, 6)}...${address.slice(-4)}`;
}

function formatTimestamp(timestamp) {
  if (!timestamp) return "-";
  return new Date(timestamp * 1000).toLocaleString();
}

function formatEth(wei) {
  if (!wei) return "0";
  return (Number(wei) / 1e18).toFixed(4);
}

// Fetch data functions
async function fetchData(query) {
  try {
    const response = await fetch('http://localhost:42069/graphql', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ query }),
    });
    
    const data = await response.json();
    if (data.errors) {
      console.error('GraphQL errors:', data.errors);
      return null;
    }
    return data.data;
  } catch (error) {
    console.error('Error fetching data:', error);
    return null;
  }
}

// Show error message on dashboard
function showErrorMessage(message) {
  const errorContainer = document.getElementById('error-container');
  if (!errorContainer) {
    // Create error container if it doesn't exist
    const main = document.querySelector('main');
    if (main) {
      const container = document.createElement('div');
      container.id = 'error-container';
      container.className = 'alert alert-danger mt-3 mb-3';
      container.style.display = 'none';
      main.prepend(container);
    }
  }
  
  const container = document.getElementById('error-container');
  if (container) {
    // Create message if doesn't exist already
    if (!container.textContent.includes(message)) {
      const errorElement = document.createElement('div');
      errorElement.textContent = message;
      container.appendChild(errorElement);
      
      // Add reload button if not present
      if (!container.querySelector('button')) {
        const reloadButton = document.createElement('button');
        reloadButton.className = 'btn btn-sm btn-danger mt-2';
        reloadButton.textContent = 'Reload Data';
        reloadButton.addEventListener('click', () => {
          container.style.display = 'none';
          container.innerHTML = '';
          loadDashboardData();
        });
        container.appendChild(reloadButton);
      }
    }
    
    container.style.display = 'block';
  }
}

// Clear error messages
function clearErrorMessages() {
  const errorContainer = document.getElementById('error-container');
  if (errorContainer) {
    errorContainer.style.display = 'none';
    errorContainer.innerHTML = '';
  }
}

// Load dashboard data
async function loadDashboardData() {
  try {
    // Clear previous errors
    clearErrorMessages();
    
    // Update loading state
    document.querySelectorAll('tbody').forEach(tbody => {
      if (tbody.children.length === 0 || 
          (tbody.children.length === 1 && tbody.children[0].textContent.includes('No data'))) {
        tbody.innerHTML = '<tr><td colspan="10" class="text-center">Loading data...</td></tr>';
      }
    });
    
    // Load all data in parallel
    await Promise.all([
      loadVaults(),
      loadVaultEvents(),
      loadVaultUsers(),
      loadLoans(),
      loadLoanEvents()
    ]);
    
    // Create charts
    createVaultActivityChart();
    createLoanHealthChart();
    
  } catch (error) {
    console.error('Error loading dashboard data:', error);
    showErrorMessage(`Failed to load dashboard data: ${error.message}`);
  }
}

// Data loading functions
async function loadVaults() {
  const query = `
    query {
      vaultEntitys {
        items {
          id
          totalAssets
          totalShares
          depositCount
          withdrawCount
          userCount
        }
      }
    }
  `;
  
  const data = await fetchData(query);
  if (!data) return;
  
  const vaults = data.vaultEntitys.items;
  const vaultsTable = document.getElementById('vaults-table');
  
  if (vaults.length === 0) {
    vaultsTable.innerHTML = '<tr><td colspan="6" class="text-center">No vaults found</td></tr>';
    return;
  }
  
  vaultsTable.innerHTML = '';
  
  vaults.forEach(vault => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatAddress(vault.id)}</td>
      <td>${formatEth(vault.totalAssets)}</td>
      <td>${formatEth(vault.totalShares)}</td>
      <td>${vault.depositCount}</td>
      <td>${vault.withdrawCount}</td>
      <td>${vault.userCount}</td>
    `;
    vaultsTable.appendChild(row);
  });
  
  // Update summary cards
  if (vaults.length > 0) {
    document.getElementById('total-assets').textContent = formatEth(vaults[0].totalAssets);
    document.getElementById('total-shares').textContent = formatEth(vaults[0].totalShares);
    document.getElementById('active-users').textContent = vaults[0].userCount;
  }
}

async function loadVaultEvents() {
  const query = `
    query {
      vaultEventEntitys(orderBy: timestamp_DESC, limit: 10) {
        items {
          id
          transactionHash
          vault {
            id
          }
          eventType
          user
          amount
          shares
          timestamp
        }
      }
    }
  `;
  
  const data = await fetchData(query);
  if (!data) return;
  
  const events = data.vaultEventEntitys?.items || [];
  const eventsTable = document.getElementById('vault-events-table');
  
  if (!eventsTable) return;
  
  if (events.length === 0) {
    eventsTable.innerHTML = '<tr><td colspan="7" class="text-center">No events found</td></tr>';
    return;
  }
  
  eventsTable.innerHTML = '';
  
  events.forEach(event => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatAddress(event.transactionHash)}</td>
      <td>${formatAddress(event.vault?.id)}</td>
      <td>${event.eventType}</td>
      <td>${formatAddress(event.user)}</td>
      <td>${formatEth(event.amount)}</td>
      <td>${formatEth(event.shares)}</td>
      <td>${formatTimestamp(event.timestamp)}</td>
    `;
    eventsTable.appendChild(row);
  });
}

async function loadVaultUsers() {
  const query = `
    query {
      vaultUserEntitys(orderBy: shares_DESC, limit: 10) {
        items {
          id
          user
          vault {
            id
          }
          shares
          depositCount
          withdrawCount
          lastActivityTimestamp
          unlockTime
        }
      }
    }
  `;
  
  const data = await fetchData(query);
  if (!data) return;
  
  const users = data.vaultUserEntitys?.items || [];
  const usersTable = document.getElementById('vault-users-table');
  
  if (!usersTable) return;
  
  if (users.length === 0) {
    usersTable.innerHTML = '<tr><td colspan="7" class="text-center">No users found</td></tr>';
    return;
  }
  
  usersTable.innerHTML = '';
  
  users.forEach(user => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatAddress(user.user)}</td>
      <td>${formatAddress(user.vault?.id)}</td>
      <td>${formatEth(user.shares)}</td>
      <td>${user.depositCount}</td>
      <td>${user.withdrawCount}</td>
      <td>${formatTimestamp(user.lastActivityTimestamp)}</td>
      <td>${user.unlockTime ? formatTimestamp(user.unlockTime) : 'N/A'}</td>
    `;
    usersTable.appendChild(row);
  });
}

async function loadLoans() {
  const query = `
    query {
      loanEntitys(orderBy: debt_DESC, limit: 10) {
        items {
          id
          borrower
          debt
          collateral
          healthFactor
          interestRate
          status
        }
      }
    }
  `;
  
  const data = await fetchData(query);
  if (!data) return;
  
  const loans = data.loanEntitys?.items || [];
  const loansTable = document.getElementById('loans-table');
  
  if (!loansTable) return;
  
  if (loans.length === 0) {
    loansTable.innerHTML = '<tr><td colspan="7" class="text-center">No loans found</td></tr>';
    return;
  }
  
  loansTable.innerHTML = '';
  
  loans.forEach(loan => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatAddress(loan.id)}</td>
      <td>${formatAddress(loan.borrower)}</td>
      <td>${formatEth(loan.debt)}</td>
      <td>${formatEth(loan.collateral)}</td>
      <td>${formatNumber(loan.healthFactor)}</td>
      <td>${formatNumber(loan.interestRate)}%</td>
      <td>${loan.status}</td>
    `;
    loansTable.appendChild(row);
  });
  
  // Update outstanding debt in summary card
  if (loans.length > 0) {
    const totalDebt = loans.reduce((sum, loan) => sum + Number(loan.debt || 0), 0);
    document.getElementById('outstanding-debt').textContent = formatEth(totalDebt.toString());
  }
}

async function loadLoanEvents() {
  const query = `
    query {
      loanEventEntitys(orderBy: timestamp_DESC, limit: 10) {
        items {
          id
          transactionHash
          loanId
          eventType
          debtChange
          collateralChange
          healthFactor
          timestamp
        }
      }
    }
  `;
  
  const data = await fetchData(query);
  if (!data) return;
  
  const events = data.loanEventEntitys?.items || [];
  const eventsTable = document.getElementById('loan-events-table');
  
  if (!eventsTable) return;
  
  if (events.length === 0) {
    eventsTable.innerHTML = '<tr><td colspan="7" class="text-center">No events found</td></tr>';
    return;
  }
  
  eventsTable.innerHTML = '';
  
  events.forEach(event => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${formatAddress(event.transactionHash)}</td>
      <td>${formatAddress(event.loanId)}</td>
      <td>${event.eventType}</td>
      <td>${formatEth(event.debtChange)}</td>
      <td>${formatEth(event.collateralChange)}</td>
      <td>${formatNumber(event.healthFactor)}</td>
      <td>${formatTimestamp(event.timestamp)}</td>
    `;
    eventsTable.appendChild(row);
  });
}

// Chart creation
function createVaultActivityChart() {
  const ctx = document.getElementById('vaultActivityChart');
  if (!ctx) return;
  
  const ctxContext = ctx.getContext('2d');
  
  // Sample data - will be replaced with real data
  new Chart(ctxContext, {
    type: 'bar',
    data: {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
      datasets: [{
        label: 'Deposits',
        data: [12, 19, 3, 5, 2, 3],
        backgroundColor: 'rgba(75, 192, 192, 0.2)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1
      }, {
        label: 'Withdrawals',
        data: [5, 10, 6, 2, 4, 7],
        backgroundColor: 'rgba(255, 99, 132, 0.2)',
        borderColor: 'rgba(255, 99, 132, 1)',
        borderWidth: 1
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

function createLoanHealthChart() {
  const ctx = document.getElementById('loanHealthChart');
  if (!ctx) return;
  
  const ctxContext = ctx.getContext('2d');
  
  // Sample data - will be replaced with real data
  new Chart(ctxContext, {
    type: 'line',
    data: {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
      datasets: [{
        label: 'Average Health Factor',
        data: [2.5, 2.3, 2.1, 1.9, 2.0, 2.2],
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1,
        tension: 0.3
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: false
        }
      }
    }
  });
}

// Initialize dashboard
function initDashboard() {
  console.log('Loading dashboard data...');
  loadDashboardData();
  
  // Refresh data every 60 seconds
  setInterval(loadDashboardData, 60000);
}

// Start dashboard when DOM is loaded
document.addEventListener('DOMContentLoaded', initDashboard);

// Check if we're in a browser environment
if (typeof document !== 'undefined') {
  // Browser environment - add event listener
  document.addEventListener('DOMContentLoaded', () => {
    initDashboard();
  });
} else {
  // Node.js environment - export functions
  console.log('Dashboard script loaded in Node.js environment');
  
  // For CommonJS environments
  if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
      loadDashboardData,
      formatAddress,
      formatTimestamp,
      formatEth
    };
  }
} 
